services:
  traefik:
    image: traefik:latest
    container_name: traefik
    security_opt:
      - no-new-privileges:true
    env_file: .env
    command:
      - "--api.insecure=true"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.http.address=:80"
      - "--entrypoints.https.address=:443"

      - "--entrypoints.http.http.redirections.entrypoint.to=https"
      - "--entrypoints.http.http.redirections.entrypoint.scheme=https"

      - "--certificatesresolvers.myresolver.acme.tlschallenge=true"
      - "--certificatesresolvers.myresolver.acme.email=${TRAEFIK_EMAIL}"
      - "--certificatesresolvers.myresolver.acme.storage=/acme/acme.json"
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock:ro"
      - "acme:/acme"
      - "traefik_logs:/var/log/traefik"
    networks:
      - proxy

  db:
    image: postgres:18-alpine
    container_name: mia-s-corner-db
    security_opt:
      - no-new-privileges:true
    env_file: .env
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
    volumes:
      - "postgres_data:/var/lib/postgresql/data"
    networks:
      - internal
    restart: unless-stopped

  app:
    build:
      context: ..
      dockerfile: infra/Dockerfile
      args:
        - NEXT_PUBLIC_BASE_URL=${NEXT_PUBLIC_BASE_URL}
        - NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL}
        - NEXT_PUBLIC_PRODUCT_PATH=${NEXT_PUBLIC_PRODUCT_PATH}
        - NEXT_PUBLIC_SUPABASE_ANON_KEY=${NEXT_PUBLIC_SUPABASE_ANON_KEY}
        - NEXT_PUBLIC_DADATA_API_KEY=${NEXT_PUBLIC_DADATA_API_KEY}
    container_name: mia-s-corner-app
    security_opt:
      - no-new-privileges:true
    depends_on:
      - db
    environment:
      DATABASE_URL: ${DATABASE_URL}
      ADMIN_USER: ${ADMIN_USER}
      ADMIN_PASSWORD: ${ADMIN_PASSWORD}
      YOOKASSA_STORE_ID: ${YOOKASSA_STORE_ID}
      YOOKASSA_API_KEY: ${YOOKASSA_API_KEY}
      YOOKASSA_CALLBACK_URL: ${YOOKASSA_CALLBACK_URL}
      YANDEX_DELIVERY_API_KEY: ${YANDEX_DELIVERY_API_KEY}
      RESEND_API_KEY: ${RESEND_API_KEY}
      SUPABASE_SERVICE_KEY: ${SUPABASE_SERVICE_KEY}
      NEXT_PUBLIC_BASE_URL: ${NEXT_PUBLIC_BASE_URL}
      NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL}
      NEXT_PUBLIC_PRODUCT_PATH: ${NEXT_PUBLIC_PRODUCT_PATH}
      NEXT_PUBLIC_SUPABASE_ANON_KEY: ${NEXT_PUBLIC_SUPABASE_ANON_KEY}
      NEXT_PUBLIC_DADATA_API_KEY: ${NEXT_PUBLIC_DADATA_API_KEY}
    networks:
      - proxy
      - internal
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.app.rule=Host(`${TRAEFIK_DOMAIN}`)"
      - "traefik.http.routers.app.entrypoints=https"
      - "traefik.http.routers.app.tls.certresolver=myresolver"
      - "traefik.http.services.app.loadbalancer.server.port=3000"
    restart: unless-stopped

networks:
  proxy:
    external: false
  internal:
    external: false
    

volumes:
  traefik_logs:
  postgres_data:
  acme: